
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>mozetl.taar.taar_similarity &#8212; python_mozetl 0.1 documentation</title>
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/alabaster.css" type="text/css" />
    <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
    <script src="../../../_static/jquery.js"></script>
    <script src="../../../_static/underscore.js"></script>
    <script src="../../../_static/doctools.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" />
   
  <link rel="stylesheet" href="../../../_static/custom.css" type="text/css" />
  
  
  <meta name="viewport" content="width=device-width, initial-scale=0.9, maximum-scale=0.9" />

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for mozetl.taar.taar_similarity</h1><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Bug 1386274 - TAAR similarity-based add-on donor list</span>

<span class="sd">This job clusters users into different groups based on their</span>
<span class="sd">active add-ons. A representative users sample is selected from</span>
<span class="sd">each cluster (&quot;donors&quot;) and is saved to a model file along</span>
<span class="sd">with a feature vector that will be used, by the TAAR library</span>
<span class="sd">module, to perform recommendations.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">click</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>

<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">date</span><span class="p">,</span> <span class="n">timedelta</span>
<span class="kn">from</span> <span class="nn">pyspark.sql</span> <span class="kn">import</span> <span class="n">SparkSession</span>
<span class="kn">from</span> <span class="nn">pyspark.sql.functions</span> <span class="kn">import</span> <span class="n">col</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.feature</span> <span class="kn">import</span> <span class="n">HashingTF</span><span class="p">,</span> <span class="n">IDF</span>
<span class="kn">from</span> <span class="nn">pyspark.ml.clustering</span> <span class="kn">import</span> <span class="n">BisectingKMeans</span>
<span class="kn">from</span> <span class="nn">pyspark.ml</span> <span class="kn">import</span> <span class="n">Pipeline</span>
<span class="kn">from</span> <span class="nn">pyspark.mllib.stat</span> <span class="kn">import</span> <span class="n">KernelDensity</span>
<span class="kn">from</span> <span class="nn">pyspark.statcounter</span> <span class="kn">import</span> <span class="n">StatCounter</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">distance</span>
<span class="kn">from</span> <span class="nn">.taar_utils</span> <span class="kn">import</span> <span class="n">store_json_to_s3</span>
<span class="kn">from</span> <span class="nn">.taar_utils</span> <span class="kn">import</span> <span class="n">load_amo_curated_whitelist</span>
<span class="kn">from</span> <span class="nn">mozetl.utils</span> <span class="kn">import</span> <span class="n">stop_session_safely</span>

<span class="c1"># Define the set of feature names to be used in the donor computations.</span>
<span class="n">CATEGORICAL_FEATURES</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;city&quot;</span><span class="p">,</span> <span class="s2">&quot;locale&quot;</span><span class="p">,</span> <span class="s2">&quot;os&quot;</span><span class="p">]</span>
<span class="n">CONTINUOUS_FEATURES</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s2">&quot;subsession_hours_sum&quot;</span><span class="p">,</span>
    <span class="s2">&quot;bookmark_count&quot;</span><span class="p">,</span>
    <span class="s2">&quot;tab_open_count&quot;</span><span class="p">,</span>
    <span class="s2">&quot;total_uri&quot;</span><span class="p">,</span>
    <span class="s2">&quot;unique_tlds&quot;</span><span class="p">,</span>
<span class="p">]</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">INFO</span><span class="p">)</span>
<span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;py4j&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">ERROR</span><span class="p">)</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<div class="viewcode-block" id="get_samples"><a class="viewcode-back" href="../../../source/mozetl.taar.html#mozetl.taar.taar_similarity.get_samples">[docs]</a><span class="k">def</span> <span class="nf">get_samples</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">date_from</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Get a DataFrame with a valid set of sample to base the next</span>
<span class="sd">    processing on.</span>

<span class="sd">    Sample is limited to submissions received since `date_from` and latest row per each client.</span>

<span class="sd">    Reference documentation is found here:</span>

<span class="sd">    Firefox Clients Daily telemetry table</span>
<span class="sd">    https://docs.telemetry.mozilla.org/datasets/batch_view/clients_daily/reference.html</span>

<span class="sd">    BUG 1485152: PR include active_addons to clients_daily table:</span>
<span class="sd">    https://github.com/mozilla/telemetry-batch-view/pull/490</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">df</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">spark</span><span class="o">.</span><span class="n">sql</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM clients_daily&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;client_id IS NOT null&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;active_addons IS NOT null&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;size(active_addons) &gt; 2&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;size(active_addons) &lt; 100&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;channel = &#39;release&#39;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;app_name = &#39;Firefox&#39;&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;submission_date_s3 &gt;= </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">date_from</span><span class="p">))</span>
        <span class="o">.</span><span class="n">selectExpr</span><span class="p">(</span>
            <span class="s2">&quot;client_id as client_id&quot;</span><span class="p">,</span>
            <span class="s2">&quot;active_addons as active_addons&quot;</span><span class="p">,</span>
            <span class="s2">&quot;city as city&quot;</span><span class="p">,</span>
            <span class="s2">&quot;cast(subsession_hours_sum as double)&quot;</span><span class="p">,</span>
            <span class="s2">&quot;locale as locale&quot;</span><span class="p">,</span>
            <span class="s2">&quot;os as os&quot;</span><span class="p">,</span>
            <span class="s2">&quot;places_bookmarks_count_mean AS bookmark_count&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scalar_parent_browser_engagement_tab_open_event_count_sum &quot;</span>
            <span class="s2">&quot;AS tab_open_count&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scalar_parent_browser_engagement_total_uri_count_sum AS total_uri&quot;</span><span class="p">,</span>
            <span class="s2">&quot;scalar_parent_browser_engagement_unique_domains_count_mean AS unique_tlds&quot;</span><span class="p">,</span>
            <span class="s2">&quot;row_number() OVER (PARTITION BY client_id ORDER BY submission_date_s3 desc) as rn&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="s2">&quot;rn = 1&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;rn&quot;</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">df</span></div>


<div class="viewcode-block" id="get_addons_per_client"><a class="viewcode-back" href="../../../source/mozetl.taar.html#mozetl.taar.taar_similarity.get_addons_per_client">[docs]</a><span class="k">def</span> <span class="nf">get_addons_per_client</span><span class="p">(</span><span class="n">users_df</span><span class="p">,</span> <span class="n">addon_whitelist</span><span class="p">,</span> <span class="n">minimum_addons_count</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Extracts a DataFrame that contains one row</span>
<span class="sd">    for each client along with the list of active add-on GUIDs.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">is_valid_addon</span><span class="p">(</span><span class="n">guid</span><span class="p">,</span> <span class="n">addon</span><span class="p">):</span>
        <span class="k">return</span> <span class="ow">not</span> <span class="p">(</span>
            <span class="n">addon</span><span class="o">.</span><span class="n">is_system</span>
            <span class="ow">or</span> <span class="n">addon</span><span class="o">.</span><span class="n">app_disabled</span>
            <span class="ow">or</span> <span class="n">addon</span><span class="o">.</span><span class="n">type</span> <span class="o">!=</span> <span class="s2">&quot;extension&quot;</span>
            <span class="ow">or</span> <span class="n">addon</span><span class="o">.</span><span class="n">user_disabled</span>
            <span class="ow">or</span> <span class="n">addon</span><span class="o">.</span><span class="n">foreign_install</span>
            <span class="ow">or</span> <span class="n">guid</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">addon_whitelist</span>
        <span class="p">)</span>

    <span class="c1"># Create an add-ons dataset un-nesting the add-on map from each</span>
    <span class="c1"># user to a list of add-on GUIDs. Also filter undesired add-ons.</span>

    <span class="c1"># Note that this list comprehension was restructured</span>
    <span class="c1"># from the original longitudinal query.  In particular, note that</span>
    <span class="c1"># each client&#39;s &#39;active_addons&#39; entry is a list containing the</span>
    <span class="c1"># a dictionary of {addon_guid: {addon_metadata_dict}}</span>

    <span class="k">def</span> <span class="nf">flatten_valid_guid_generator</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;active_addons&quot;</span><span class="p">]:</span>
            <span class="n">addon_guid</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s2">&quot;addon_id&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">is_valid_addon</span><span class="p">(</span><span class="n">addon_guid</span><span class="p">,</span> <span class="n">data</span><span class="p">):</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">addon_guid</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">users_df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span>
            <span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;client_id&quot;</span><span class="p">],</span> <span class="nb">list</span><span class="p">(</span><span class="n">flatten_valid_guid_generator</span><span class="p">(</span><span class="n">p</span><span class="p">)))</span>
        <span class="p">)</span>
        <span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&gt;</span> <span class="n">minimum_addons_count</span><span class="p">)</span>
        <span class="o">.</span><span class="n">toDF</span><span class="p">([</span><span class="s2">&quot;client_id&quot;</span><span class="p">,</span> <span class="s2">&quot;addon_ids&quot;</span><span class="p">])</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="compute_clusters"><a class="viewcode-back" href="../../../source/mozetl.taar.html#mozetl.taar.taar_similarity.compute_clusters">[docs]</a><span class="k">def</span> <span class="nf">compute_clusters</span><span class="p">(</span><span class="n">addons_df</span><span class="p">,</span> <span class="n">num_clusters</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Performs user clustering by using add-on ids as features.&quot;&quot;&quot;</span>

    <span class="c1"># Build the stages of the pipeline. We need hashing to make the next</span>
    <span class="c1"># steps work.</span>
    <span class="n">hashing_stage</span> <span class="o">=</span> <span class="n">HashingTF</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s2">&quot;addon_ids&quot;</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s2">&quot;hashed_features&quot;</span><span class="p">)</span>
    <span class="n">idf_stage</span> <span class="o">=</span> <span class="n">IDF</span><span class="p">(</span><span class="n">inputCol</span><span class="o">=</span><span class="s2">&quot;hashed_features&quot;</span><span class="p">,</span> <span class="n">outputCol</span><span class="o">=</span><span class="s2">&quot;features&quot;</span><span class="p">,</span> <span class="n">minDocFreq</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># As a future improvement, we may add a sane value for the minimum cluster size</span>
    <span class="c1"># to BisectingKMeans (e.g. minDivisibleClusterSize). For now, just make sure</span>
    <span class="c1"># to pass along the random seed if needed for tests.</span>
    <span class="n">kmeans_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="n">random_seed</span><span class="p">}</span> <span class="k">if</span> <span class="n">random_seed</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">bkmeans_stage</span> <span class="o">=</span> <span class="n">BisectingKMeans</span><span class="p">(</span><span class="n">k</span><span class="o">=</span><span class="n">num_clusters</span><span class="p">,</span> <span class="o">**</span><span class="n">kmeans_kwargs</span><span class="p">)</span>
    <span class="n">pipeline</span> <span class="o">=</span> <span class="n">Pipeline</span><span class="p">(</span><span class="n">stages</span><span class="o">=</span><span class="p">[</span><span class="n">hashing_stage</span><span class="p">,</span> <span class="n">idf_stage</span><span class="p">,</span> <span class="n">bkmeans_stage</span><span class="p">])</span>

    <span class="c1"># Run the pipeline and compute the results.</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">pipeline</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">addons_df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">model</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">addons_df</span><span class="p">)</span><span class="o">.</span><span class="n">select</span><span class="p">([</span><span class="s2">&quot;client_id&quot;</span><span class="p">,</span> <span class="s2">&quot;prediction&quot;</span><span class="p">])</span></div>


<div class="viewcode-block" id="get_donor_pools"><a class="viewcode-back" href="../../../source/mozetl.taar.html#mozetl.taar.taar_similarity.get_donor_pools">[docs]</a><span class="k">def</span> <span class="nf">get_donor_pools</span><span class="p">(</span><span class="n">users_df</span><span class="p">,</span> <span class="n">clusters_df</span><span class="p">,</span> <span class="n">num_donors</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Samples users from each cluster.&quot;&quot;&quot;</span>
    <span class="n">cluster_population</span> <span class="o">=</span> <span class="n">clusters_df</span><span class="o">.</span><span class="n">groupBy</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="n">clusters_histogram</span> <span class="o">=</span> <span class="p">[(</span><span class="n">x</span><span class="p">[</span><span class="s2">&quot;prediction&quot;</span><span class="p">],</span> <span class="n">x</span><span class="p">[</span><span class="s2">&quot;count&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">cluster_population</span><span class="p">]</span>

    <span class="c1"># Sort in-place from highest to lowest populated cluster.</span>
    <span class="n">clusters_histogram</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Save the cluster ids and their respective scores separately.</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="p">[</span><span class="n">cluster_id</span> <span class="k">for</span> <span class="n">cluster_id</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">clusters_histogram</span><span class="p">]</span>
    <span class="n">counts</span> <span class="o">=</span> <span class="p">[</span><span class="n">donor_count</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">donor_count</span> <span class="ow">in</span> <span class="n">clusters_histogram</span><span class="p">]</span>

    <span class="c1"># Compute the proportion of user in each cluster.</span>
    <span class="n">total_donors_in_clusters</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">counts</span><span class="p">)</span>
    <span class="n">clust_sample</span> <span class="o">=</span> <span class="p">[</span><span class="nb">float</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="o">/</span> <span class="n">total_donors_in_clusters</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">counts</span><span class="p">]</span>
    <span class="n">sampling_proportions</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">clusters</span><span class="p">,</span> <span class="n">clust_sample</span><span class="p">)))</span>

    <span class="c1"># Sample the users in each cluster according to the proportions</span>
    <span class="c1"># and pass along the random seed if needed for tests.</span>
    <span class="n">sampling_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="n">random_seed</span><span class="p">}</span> <span class="k">if</span> <span class="n">random_seed</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">donor_df</span> <span class="o">=</span> <span class="n">clusters_df</span><span class="o">.</span><span class="n">sampleBy</span><span class="p">(</span>
        <span class="s2">&quot;prediction&quot;</span><span class="p">,</span> <span class="n">fractions</span><span class="o">=</span><span class="n">sampling_proportions</span><span class="p">,</span> <span class="o">**</span><span class="n">sampling_kwargs</span>
    <span class="p">)</span>
    <span class="c1"># Get the specific number of donors for each cluster and drop the</span>
    <span class="c1"># predicted cluster number information.</span>
    <span class="n">current_sample_size</span> <span class="o">=</span> <span class="n">donor_df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
    <span class="n">donor_pool_df</span> <span class="o">=</span> <span class="n">donor_df</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span>
        <span class="kc">False</span><span class="p">,</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_donors</span><span class="p">)</span> <span class="o">/</span> <span class="n">current_sample_size</span><span class="p">,</span> <span class="o">**</span><span class="n">sampling_kwargs</span>
    <span class="p">)</span>
    <span class="k">return</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">donor_pool_df</span></div>


<div class="viewcode-block" id="get_donors"><a class="viewcode-back" href="../../../source/mozetl.taar.html#mozetl.taar.taar_similarity.get_donors">[docs]</a><span class="k">def</span> <span class="nf">get_donors</span><span class="p">(</span>
    <span class="n">spark</span><span class="p">,</span> <span class="n">num_clusters</span><span class="p">,</span> <span class="n">num_donors</span><span class="p">,</span> <span class="n">addon_whitelist</span><span class="p">,</span> <span class="n">date_from</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="c1"># Get the data for the potential add-on donors.</span>
    <span class="n">users_sample</span> <span class="o">=</span> <span class="n">get_samples</span><span class="p">(</span><span class="n">spark</span><span class="p">,</span> <span class="n">date_from</span><span class="p">)</span>
    <span class="c1"># Get add-ons from selected users and make sure they are</span>
    <span class="c1"># useful for making a recommendation.</span>
    <span class="n">addons_df</span> <span class="o">=</span> <span class="n">get_addons_per_client</span><span class="p">(</span><span class="n">users_sample</span><span class="p">,</span> <span class="n">addon_whitelist</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="n">addons_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
    <span class="c1"># Perform clustering by using the add-on info.</span>
    <span class="n">clusters</span> <span class="o">=</span> <span class="n">compute_clusters</span><span class="p">(</span><span class="n">addons_df</span><span class="p">,</span> <span class="n">num_clusters</span><span class="p">,</span> <span class="n">random_seed</span><span class="p">)</span>
    <span class="c1"># Sample representative (&quot;donors&quot;) users from each cluster.</span>
    <span class="n">cluster_ids</span><span class="p">,</span> <span class="n">donors_df</span> <span class="o">=</span> <span class="n">get_donor_pools</span><span class="p">(</span>
        <span class="n">users_sample</span><span class="p">,</span> <span class="n">clusters</span><span class="p">,</span> <span class="n">num_donors</span><span class="p">,</span> <span class="n">random_seed</span>
    <span class="p">)</span>

    <span class="c1"># Finally, get the feature vectors for users that represent</span>
    <span class="c1"># each cluster. Since the &quot;active_addons&quot; in &quot;users_sample&quot;</span>
    <span class="c1"># are in a |MapType| and contain system add-ons as well, just</span>
    <span class="c1"># use the cleaned up list from &quot;addons_df&quot;.</span>
    <span class="k">return</span> <span class="p">(</span>
        <span class="n">cluster_ids</span><span class="p">,</span>
        <span class="p">(</span>
            <span class="n">users_sample</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">donors_df</span><span class="p">,</span> <span class="s2">&quot;client_id&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;active_addons&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">addons_df</span><span class="p">,</span> <span class="s2">&quot;client_id&quot;</span><span class="p">,</span> <span class="s2">&quot;left&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;client_id&quot;</span><span class="p">)</span>
            <span class="o">.</span><span class="n">withColumnRenamed</span><span class="p">(</span><span class="s2">&quot;addon_ids&quot;</span><span class="p">,</span> <span class="s2">&quot;active_addons&quot;</span><span class="p">)</span>
        <span class="p">),</span>
    <span class="p">)</span></div>


<div class="viewcode-block" id="format_donors_dictionary"><a class="viewcode-back" href="../../../source/mozetl.taar.html#mozetl.taar.taar_similarity.format_donors_dictionary">[docs]</a><span class="k">def</span> <span class="nf">format_donors_dictionary</span><span class="p">(</span><span class="n">donors_df</span><span class="p">):</span>
    <span class="n">cleaned_records</span> <span class="o">=</span> <span class="n">donors_df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">collect</span><span class="p">()</span>
    <span class="c1"># Convert each row to a dictionary.</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">asDict</span><span class="p">()</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cleaned_records</span><span class="p">]</span></div>


<div class="viewcode-block" id="similarity_function"><a class="viewcode-back" href="../../../source/mozetl.taar.html#mozetl.taar.taar_similarity.similarity_function">[docs]</a><span class="k">def</span> <span class="nf">similarity_function</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Similarity function for comparing user features.</span>

<span class="sd">    This actually really should be implemented in taar.similarity_recommender</span>
<span class="sd">    and then imported here for consistency.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">safe_get</span><span class="p">(</span><span class="n">field</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="n">default_value</span><span class="p">):</span>
        <span class="c1"># Safely get a value from the Row. If the value is None, get the</span>
        <span class="c1"># default value.</span>
        <span class="k">return</span> <span class="n">row</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="k">if</span> <span class="n">row</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">default_value</span>

    <span class="c1"># Extract the values for the categorical and continuous features for both</span>
    <span class="c1"># the x and y samples. Use an empty string as the default value for missing</span>
    <span class="c1"># categorical fields and 0 for the continuous ones.</span>
    <span class="n">x_categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">safe_get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CATEGORICAL_FEATURES</span><span class="p">]</span>
    <span class="n">x_continuous_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">safe_get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CONTINUOUS_FEATURES</span><span class="p">]</span>
    <span class="n">y_categorical_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">safe_get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CATEGORICAL_FEATURES</span><span class="p">]</span>
    <span class="n">y_continuous_features</span> <span class="o">=</span> <span class="p">[</span><span class="n">safe_get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">CONTINUOUS_FEATURES</span><span class="p">]</span>

    <span class="c1"># Here a larger distance indicates a poorer match between categorical variables.</span>
    <span class="n">j_d</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">hamming</span><span class="p">(</span><span class="n">x_categorical_features</span><span class="p">,</span> <span class="n">y_categorical_features</span><span class="p">)</span>
    <span class="n">j_c</span> <span class="o">=</span> <span class="n">distance</span><span class="o">.</span><span class="n">canberra</span><span class="p">(</span><span class="n">x_continuous_features</span><span class="p">,</span> <span class="n">y_continuous_features</span><span class="p">)</span>

    <span class="c1"># Take the product of similarities to attain a univariate similarity score.</span>
    <span class="c1"># Add a minimal constant to prevent zero values from categorical features.</span>
    <span class="c1"># Note: since both the distance function return a Numpy type, we need to</span>
    <span class="c1"># call the |item| function to get the underlying Python type. If we don&#39;t</span>
    <span class="c1"># do that this job will fail when performing KDE due to SPARK-20803 on</span>
    <span class="c1"># Spark 2.2.0.</span>
    <span class="k">return</span> <span class="nb">abs</span><span class="p">((</span><span class="n">j_c</span> <span class="o">+</span> <span class="mf">0.001</span><span class="p">)</span> <span class="o">*</span> <span class="n">j_d</span><span class="p">)</span><span class="o">.</span><span class="n">item</span><span class="p">()</span></div>


<div class="viewcode-block" id="generate_non_cartesian_pairs"><a class="viewcode-back" href="../../../source/mozetl.taar.html#mozetl.taar.taar_similarity.generate_non_cartesian_pairs">[docs]</a><span class="k">def</span> <span class="nf">generate_non_cartesian_pairs</span><span class="p">(</span><span class="n">first_rdd</span><span class="p">,</span> <span class="n">second_rdd</span><span class="p">):</span>
    <span class="c1"># Add an index to all the elements in each RDD.</span>
    <span class="n">rdd1_with_indices</span> <span class="o">=</span> <span class="n">first_rdd</span><span class="o">.</span><span class="n">zipWithIndex</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">rdd2_with_indices</span> <span class="o">=</span> <span class="n">second_rdd</span><span class="o">.</span><span class="n">zipWithIndex</span><span class="p">()</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">p</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="c1"># Join the RDDs using the indices as keys, then strip</span>
    <span class="c1"># them off before returning an RDD like [&lt;v1, v2&gt;, ...]</span>
    <span class="k">return</span> <span class="n">rdd1_with_indices</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">rdd2_with_indices</span><span class="p">)</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span></div>


<div class="viewcode-block" id="get_lr_curves"><a class="viewcode-back" href="../../../source/mozetl.taar.html#mozetl.taar.taar_similarity.get_lr_curves">[docs]</a><span class="k">def</span> <span class="nf">get_lr_curves</span><span class="p">(</span>
    <span class="n">spark</span><span class="p">,</span> <span class="n">features_df</span><span class="p">,</span> <span class="n">cluster_ids</span><span class="p">,</span> <span class="n">kernel_bandwidth</span><span class="p">,</span> <span class="n">num_pdf_points</span><span class="p">,</span> <span class="n">random_seed</span><span class="o">=</span><span class="kc">None</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Compute the likelihood ratio curves for clustered clients.</span>

<span class="sd">    Work-flow followed in this function is as follows:</span>

<span class="sd">     * Access the DataFrame including cluster numbers and features.</span>
<span class="sd">     * Load same similarity function that will be used in TAAR module.</span>
<span class="sd">     * Iterate through each cluster and compute in-cluster similarity.</span>
<span class="sd">     * Iterate through each cluster and compute out-cluster similarity.</span>
<span class="sd">     * Compute the kernel density estimate (KDE) per similarity score.</span>
<span class="sd">     * Linearly down-sample both PDFs to 1000 points.</span>

<span class="sd">    :param spark: the SparkSession object.</span>
<span class="sd">    :param features_df: the DataFrame containing the user features (e.g. the</span>
<span class="sd">                        ones coming from |get_donors|).</span>
<span class="sd">    :param cluster_ids: the list of cluster ids (e.g. the one coming from |get_donors|).</span>
<span class="sd">    :param kernel_bandwidth: the kernel bandwidth used to estimate the kernel densities.</span>
<span class="sd">    :param num_pdf_points: the number of points to sample for the LR-curves.</span>
<span class="sd">    :param random_seed: the provided random seed (fixed in tests).</span>
<span class="sd">    :return: A list in the following format</span>
<span class="sd">        [(idx, (lr-numerator-for-idx, lr-denominator-for-idx)), (...), ...]</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Instantiate holder lists for inter- and intra-cluster scores.</span>
    <span class="n">same_cluster_scores_rdd</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">emptyRDD</span><span class="p">()</span>
    <span class="n">different_clusters_scores_rdd</span> <span class="o">=</span> <span class="n">spark</span><span class="o">.</span><span class="n">sparkContext</span><span class="o">.</span><span class="n">emptyRDD</span><span class="p">()</span>

    <span class="n">random_split_kwargs</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;seed&quot;</span><span class="p">:</span> <span class="n">random_seed</span><span class="p">}</span> <span class="k">if</span> <span class="n">random_seed</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">cluster_number</span> <span class="ow">in</span> <span class="n">cluster_ids</span><span class="p">:</span>
        <span class="c1"># Pick the features for users belonging to the current cluster.</span>
        <span class="n">current_cluster_df</span> <span class="o">=</span> <span class="n">features_df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="n">cluster_number</span><span class="p">)</span>
        <span class="c1"># Pick the features for users belonging to all the other clusters.</span>
        <span class="n">other_clusters_df</span> <span class="o">=</span> <span class="n">features_df</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">col</span><span class="p">(</span><span class="s2">&quot;prediction&quot;</span><span class="p">)</span> <span class="o">!=</span> <span class="n">cluster_number</span><span class="p">)</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span>
            <span class="s2">&quot;Computing scores for cluster&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;cluster_id&quot;</span><span class="p">:</span> <span class="n">cluster_number</span><span class="p">}</span>
        <span class="p">)</span>

        <span class="c1"># Compares the similarity score between pairs of clients in the same cluster.</span>
        <span class="n">cluster_half_1</span><span class="p">,</span> <span class="n">cluster_half_2</span> <span class="o">=</span> <span class="n">current_cluster_df</span><span class="o">.</span><span class="n">rdd</span><span class="o">.</span><span class="n">randomSplit</span><span class="p">(</span>
            <span class="p">[</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">],</span> <span class="o">**</span><span class="n">random_split_kwargs</span>
        <span class="p">)</span>
        <span class="n">pair_rdd</span> <span class="o">=</span> <span class="n">generate_non_cartesian_pairs</span><span class="p">(</span><span class="n">cluster_half_1</span><span class="p">,</span> <span class="n">cluster_half_2</span><span class="p">)</span>
        <span class="n">intra_scores_rdd</span> <span class="o">=</span> <span class="n">pair_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">similarity_function</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">))</span>
        <span class="n">same_cluster_scores_rdd</span> <span class="o">=</span> <span class="n">same_cluster_scores_rdd</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">intra_scores_rdd</span><span class="p">)</span>

        <span class="c1"># Compares the similarity score between pairs of clients in different clusters.</span>
        <span class="n">pair_rdd</span> <span class="o">=</span> <span class="n">generate_non_cartesian_pairs</span><span class="p">(</span>
            <span class="n">current_cluster_df</span><span class="o">.</span><span class="n">rdd</span><span class="p">,</span> <span class="n">other_clusters_df</span><span class="o">.</span><span class="n">rdd</span>
        <span class="p">)</span>
        <span class="n">inter_scores_rdd</span> <span class="o">=</span> <span class="n">pair_rdd</span><span class="o">.</span><span class="n">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">r</span><span class="p">:</span> <span class="n">similarity_function</span><span class="p">(</span><span class="o">*</span><span class="n">r</span><span class="p">))</span>
        <span class="n">different_clusters_scores_rdd</span> <span class="o">=</span> <span class="n">different_clusters_scores_rdd</span><span class="o">.</span><span class="n">union</span><span class="p">(</span>
            <span class="n">inter_scores_rdd</span>
        <span class="p">)</span>

    <span class="c1"># Determine a range of observed similarity values linearly spaced.</span>
    <span class="n">all_scores_rdd</span> <span class="o">=</span> <span class="n">same_cluster_scores_rdd</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">different_clusters_scores_rdd</span><span class="p">)</span>
    <span class="n">stats</span> <span class="o">=</span> <span class="n">all_scores_rdd</span><span class="o">.</span><span class="n">aggregate</span><span class="p">(</span>
        <span class="n">StatCounter</span><span class="p">(),</span> <span class="n">StatCounter</span><span class="o">.</span><span class="n">merge</span><span class="p">,</span> <span class="n">StatCounter</span><span class="o">.</span><span class="n">mergeStats</span>
    <span class="p">)</span>
    <span class="n">min_similarity</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">minValue</span>
    <span class="n">max_similarity</span> <span class="o">=</span> <span class="n">stats</span><span class="o">.</span><span class="n">maxValue</span>
    <span class="n">lr_index</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span>
        <span class="n">min_similarity</span><span class="p">,</span>
        <span class="n">max_similarity</span><span class="p">,</span>
        <span class="nb">float</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">min_similarity</span> <span class="o">-</span> <span class="n">max_similarity</span><span class="p">))</span> <span class="o">/</span> <span class="n">num_pdf_points</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="c1"># Kernel density estimate for the inter-cluster comparison scores.</span>
    <span class="n">kd_dc</span> <span class="o">=</span> <span class="n">KernelDensity</span><span class="p">()</span>
    <span class="n">kd_dc</span><span class="o">.</span><span class="n">setSample</span><span class="p">(</span><span class="n">different_clusters_scores_rdd</span><span class="p">)</span>
    <span class="n">kd_dc</span><span class="o">.</span><span class="n">setBandwidth</span><span class="p">(</span><span class="n">kernel_bandwidth</span><span class="p">)</span>
    <span class="n">denominator_density</span> <span class="o">=</span> <span class="n">kd_dc</span><span class="o">.</span><span class="n">estimate</span><span class="p">(</span><span class="n">lr_index</span><span class="p">)</span>

    <span class="c1"># Kernel density estimate for the intra-cluster comparison scores.</span>
    <span class="n">kd_sc</span> <span class="o">=</span> <span class="n">KernelDensity</span><span class="p">()</span>
    <span class="n">kd_sc</span><span class="o">.</span><span class="n">setSample</span><span class="p">(</span><span class="n">same_cluster_scores_rdd</span><span class="p">)</span>
    <span class="n">kd_sc</span><span class="o">.</span><span class="n">setBandwidth</span><span class="p">(</span><span class="n">kernel_bandwidth</span><span class="p">)</span>
    <span class="n">numerator_density</span> <span class="o">=</span> <span class="n">kd_sc</span><span class="o">.</span><span class="n">estimate</span><span class="p">(</span><span class="n">lr_index</span><span class="p">)</span>

    <span class="c1"># Structure this in the correct output format.</span>
    <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">lr_index</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">numerator_density</span><span class="p">,</span> <span class="n">denominator_density</span><span class="p">))))</span></div>


<div class="viewcode-block" id="today_minus_90_days"><a class="viewcode-back" href="../../../source/mozetl.taar.html#mozetl.taar.taar_similarity.today_minus_90_days">[docs]</a><span class="k">def</span> <span class="nf">today_minus_90_days</span><span class="p">():</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">date</span><span class="o">.</span><span class="n">today</span><span class="p">()</span> <span class="o">+</span> <span class="n">timedelta</span><span class="p">(</span><span class="n">days</span><span class="o">=-</span><span class="mi">90</span><span class="p">))</span><span class="o">.</span><span class="n">strftime</span><span class="p">(</span><span class="s2">&quot;%Y%m</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span></div>


<span class="nd">@click</span><span class="o">.</span><span class="n">command</span><span class="p">()</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--date&quot;</span><span class="p">,</span> <span class="n">required</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--bucket&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;telemetry-parquet&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--prefix&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s2">&quot;taar/similarity/&quot;</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--num_clusters&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--num_donors&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--kernel_bandwidth&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mf">0.35</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--num_pdf_points&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="mi">1000</span><span class="p">)</span>
<span class="nd">@click</span><span class="o">.</span><span class="n">option</span><span class="p">(</span><span class="s2">&quot;--clients_sample_date_from&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">today_minus_90_days</span><span class="p">())</span>
<span class="k">def</span> <span class="nf">main</span><span class="p">(</span>
    <span class="n">date</span><span class="p">,</span>
    <span class="n">bucket</span><span class="p">,</span>
    <span class="n">prefix</span><span class="p">,</span>
    <span class="n">num_clusters</span><span class="p">,</span>
    <span class="n">num_donors</span><span class="p">,</span>
    <span class="n">kernel_bandwidth</span><span class="p">,</span>
    <span class="n">num_pdf_points</span><span class="p">,</span>
    <span class="n">clients_sample_date_from</span><span class="p">,</span>
<span class="p">):</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Sampling clients since </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clients_sample_date_from</span><span class="p">))</span>

    <span class="n">spark</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">SparkSession</span><span class="o">.</span><span class="n">builder</span><span class="o">.</span><span class="n">appName</span><span class="p">(</span><span class="s2">&quot;taar_similarity&quot;</span><span class="p">)</span>
        <span class="o">.</span><span class="n">enableHiveSupport</span><span class="p">()</span>
        <span class="o">.</span><span class="n">getOrCreate</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">num_donors</span> <span class="o">&lt;</span> <span class="mi">100</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;Less than 100 donors were requested.&quot;</span><span class="p">,</span> <span class="n">extra</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;donors&quot;</span><span class="p">:</span> <span class="n">num_donors</span><span class="p">}</span>
        <span class="p">)</span>
        <span class="n">num_donors</span> <span class="o">=</span> <span class="mi">100</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading the AMO whitelist...&quot;</span><span class="p">)</span>
    <span class="n">whitelist</span> <span class="o">=</span> <span class="n">load_amo_curated_whitelist</span><span class="p">()</span>

    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Computing the list of donors...&quot;</span><span class="p">)</span>

    <span class="c1"># Compute the donors clusters and the LR curves.</span>
    <span class="n">cluster_ids</span><span class="p">,</span> <span class="n">donors_df</span> <span class="o">=</span> <span class="n">get_donors</span><span class="p">(</span>
        <span class="n">spark</span><span class="p">,</span> <span class="n">num_clusters</span><span class="p">,</span> <span class="n">num_donors</span><span class="p">,</span> <span class="n">whitelist</span><span class="p">,</span> <span class="n">clients_sample_date_from</span>
    <span class="p">)</span>
    <span class="n">donors_df</span><span class="o">.</span><span class="n">cache</span><span class="p">()</span>
    <span class="n">lr_curves</span> <span class="o">=</span> <span class="n">get_lr_curves</span><span class="p">(</span>
        <span class="n">spark</span><span class="p">,</span> <span class="n">donors_df</span><span class="p">,</span> <span class="n">cluster_ids</span><span class="p">,</span> <span class="n">kernel_bandwidth</span><span class="p">,</span> <span class="n">num_pdf_points</span>
    <span class="p">)</span>

    <span class="c1"># Store them.</span>
    <span class="n">donors</span> <span class="o">=</span> <span class="n">format_donors_dictionary</span><span class="p">(</span><span class="n">donors_df</span><span class="p">)</span>
    <span class="n">store_json_to_s3</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">donors</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;donors&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">bucket</span><span class="p">)</span>
    <span class="n">store_json_to_s3</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">lr_curves</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span> <span class="s2">&quot;lr_curves&quot;</span><span class="p">,</span> <span class="n">date</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">bucket</span><span class="p">)</span>
    <span class="n">stop_session_safely</span><span class="p">(</span><span class="n">spark</span><span class="p">)</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../../index.html">python_mozetl</a></h1>








<h3>Navigation</h3>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html">Firefox Telemetry Python ETL</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#benefits">Benefits</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#tests">Tests</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#manual-execution">Manual Execution</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#scheduling">Scheduling</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../readme.html#early-stage-etl-jobs">Early Stage ETL Jobs</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../../index.html">Documentation overview</a><ul>
  <li><a href="../../index.html">Module code</a><ul>
  </ul></li>
  </ul></li>
</ul>
</div>
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &copy;2018, Ryan Harter.
      
      |
      Powered by <a href="http://sphinx-doc.org/">Sphinx 3.5.4</a>
      &amp; <a href="https://github.com/bitprophet/alabaster">Alabaster 0.7.12</a>
      
    </div>

    

    
  </body>
</html>